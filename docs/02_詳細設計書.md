# 詳細設計書 - Asset Allocation Tool (Next.js版)

## 1. システムアーキテクチャ

### 1.1 全体構成
```
┌─────────────────────────────────────────────────┐
│                   Client (Browser)               │
│  ┌─────────────────────────────────────────┐   │
│  │          Next.js 15 App Router          │   │
│  │  ┌────────────┐  ┌──────────────┐     │   │
│  │  │   Pages    │  │  Components  │     │   │
│  │  └────────────┘  └──────────────┘     │   │
│  │  ┌────────────┐  ┌──────────────┐     │   │
│  │  │   Hooks    │  │   Services   │     │   │
│  │  └────────────┘  └──────────────┘     │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                          │
                          ▼
            ┌──────────────────────────┐
            │     Vercel Edge         │
            │   ┌──────────────┐      │
            │   │  API Routes  │      │
            │   └──────────────┘      │
            └──────────────────────────┘
                          │
                          ▼
            ┌──────────────────────────┐
            │   External APIs          │
            │  ┌──────────────┐       │
            │  │Yahoo Finance │       │
            │  └──────────────┘       │
            └──────────────────────────┘
```

### 1.2 技術スタック詳細

#### フロントエンド
- **Framework**: Next.js 15.0+ (App Router)
- **Language**: TypeScript 5.3+
- **Styling**: TailwindCSS 3.4+
- **UI Components**: shadcn/ui
- **Animation**: Framer Motion 11+
- **Charts**: Recharts 2.9+ / Plotly.js
- **State Management**: Zustand 4.4+
- **Form Handling**: React Hook Form 7.48+
- **Validation**: Zod 3.22+
- **Date Handling**: date-fns 3.0+

#### バックエンド
- **API Routes**: Next.js API Routes
- **Data Fetching**: SWR 2.2+
- **HTTP Client**: Axios 1.6+
- **Finance Data**: yahoo-finance2 2.11+

#### 開発ツール
- **Package Manager**: pnpm 8.14+
- **Linting**: ESLint 8.56+
- **Formatting**: Prettier 3.2+
- **Testing**: Jest 29+ & React Testing Library
- **E2E Testing**: Playwright 1.41+
- **Git Hooks**: Husky 8.0+

## 2. ディレクトリ構造

```
asset-allocation-nextjs/
├── app/                        # Next.js 15 App Router
│   ├── (auth)/                # 認証関連ページ（将来実装）
│   ├── (dashboard)/           # メインアプリケーション
│   │   ├── layout.tsx         # ダッシュボードレイアウト
│   │   ├── page.tsx           # ホームページ
│   │   ├── portfolio/         # ポートフォリオ分析
│   │   │   ├── page.tsx
│   │   │   └── [id]/page.tsx
│   │   ├── analysis/          # 詳細分析
│   │   └── settings/          # 設定
│   ├── api/                   # API Routes
│   │   ├── assets/            # 資産データAPI
│   │   ├── portfolio/         # ポートフォリオAPI
│   │   └── optimize/          # 最適化API
│   ├── layout.tsx             # ルートレイアウト
│   ├── page.tsx               # ランディングページ
│   └── globals.css
│
├── components/                 # Reactコンポーネント
│   ├── ui/                    # shadcn/ui components
│   ├── charts/                # チャートコンポーネント
│   │   ├── EfficiencyFrontier.tsx
│   │   ├── PriceChart.tsx
│   │   ├── CorrelationMatrix.tsx
│   │   └── AllocationPie.tsx
│   ├── forms/                 # フォームコンポーネント
│   │   ├── AssetSelector.tsx
│   │   ├── DateRangePicker.tsx
│   │   └── SettingsForm.tsx
│   ├── layouts/              # レイアウトコンポーネント
│   │   ├── Header.tsx
│   │   ├── Sidebar.tsx
│   │   └── Footer.tsx
│   └── features/             # 機能別コンポーネント
│       ├── portfolio/
│       ├── analysis/
│       └── optimization/
│
├── lib/                       # ライブラリ・ユーティリティ
│   ├── api/                  # APIクライアント
│   ├── calculations/         # 計算ロジック
│   │   ├── portfolio.ts
│   │   ├── optimization.ts
│   │   └── statistics.ts
│   ├── constants/            # 定数定義
│   ├── hooks/                # カスタムフック
│   ├── stores/               # Zustand stores
│   ├── types/                # TypeScript型定義
│   ├── utils/                # ユーティリティ関数
│   └── validations/          # バリデーションスキーマ
│
├── public/                    # 静的ファイル
│   ├── images/
│   └── fonts/
│
├── styles/                    # スタイルファイル
├── tests/                     # テストファイル
│   ├── unit/
│   ├── integration/
│   └── e2e/
│
└── config/                    # 設定ファイル
    ├── next.config.js
    ├── tailwind.config.js
    ├── tsconfig.json
    └── jest.config.js
```

## 3. データモデル設計

### 3.1 主要な型定義

```typescript
// Asset (資産)
interface Asset {
  id: string;
  symbol: string;           // ティッカーシンボル
  name: string;            // 表示名
  type: AssetType;         // 資産タイプ
  exchange?: string;       // 取引所
  currency?: string;       // 通貨
}

enum AssetType {
  STOCK = 'stock',
  ETF = 'etf',
  BOND = 'bond',
  COMMODITY = 'commodity',
  CRYPTO = 'crypto',
  REIT = 'reit',
}

// Portfolio (ポートフォリオ)
interface Portfolio {
  id: string;
  name: string;
  assets: PortfolioAsset[];
  createdAt: Date;
  updatedAt: Date;
  settings: PortfolioSettings;
}

interface PortfolioAsset {
  asset: Asset;
  weight: number;          // 0-1の割合
  quantity?: number;       // 数量
  value?: number;          // 現在価値
}

// Historical Data (履歴データ)
interface HistoricalData {
  symbol: string;
  date: Date;
  open: number;
  high: number;
  low: number;
  close: number;
  adjClose: number;
  volume: number;
}

// Optimization Result (最適化結果)
interface OptimizationResult {
  type: OptimizationType;
  weights: number[];
  expectedReturn: number;
  risk: number;
  sharpeRatio: number;
  assets: Asset[];
}

enum OptimizationType {
  MAX_SHARPE = 'max_sharpe',
  MIN_VARIANCE = 'min_variance',
  MAX_RETURN = 'max_return',
  RISK_PARITY = 'risk_parity',
}

// Analysis Result (分析結果)
interface AnalysisResult {
  portfolioId: string;
  metrics: PortfolioMetrics;
  efficientFrontier: FrontierPoint[];
  correlationMatrix: number[][];
  historicalReturns: TimeSeries[];
}

interface PortfolioMetrics {
  totalReturn: number;
  annualizedReturn: number;
  volatility: number;
  sharpeRatio: number;
  sortinoRatio: number;
  maxDrawdown: number;
  var95: number;           // Value at Risk 95%
  cvar95: number;          // Conditional VaR 95%
  beta?: number;
  alpha?: number;
}
```

### 3.2 API レスポンス型

```typescript
// API共通レスポンス
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: ApiError;
  metadata?: ResponseMetadata;
}

interface ApiError {
  code: string;
  message: string;
  details?: any;
}

interface ResponseMetadata {
  timestamp: string;
  version: string;
  cached: boolean;
  ttl?: number;
}
```

## 4. コンポーネント設計

### 4.1 主要コンポーネント階層

```
<DashboardLayout>
  <Header>
    <Navigation />
    <ThemeToggle />
    <UserMenu />
  </Header>
  
  <Sidebar>
    <PortfolioList />
    <QuickActions />
  </Sidebar>
  
  <MainContent>
    <PortfolioBuilder>
      <AssetSelector />
      <DateRangePicker />
      <SettingsPanel />
    </PortfolioBuilder>
    
    <AnalysisView>
      <TabPanel>
        <PriceChart />
        <EfficiencyFrontier />
        <AllocationChart />
        <CorrelationMatrix />
        <MetricsGrid />
      </TabPanel>
    </AnalysisView>
    
    <OptimizationPanel>
      <OptimizationControls />
      <OptimizationResults />
    </OptimizationPanel>
  </MainContent>
</DashboardLayout>
```

### 4.2 コンポーネント詳細設計

#### AssetSelector Component
```typescript
interface AssetSelectorProps {
  selectedAssets: Asset[];
  onAssetsChange: (assets: Asset[]) => void;
  maxAssets?: number;
  presets?: AssetPreset[];
}

// Features:
// - 検索機能（デバウンス付き）
// - プリセット選択
// - ドラッグ&ドロップ対応
// - リアルタイムバリデーション
```

#### EfficiencyFrontier Component
```typescript
interface EfficiencyFrontierProps {
  data: FrontierPoint[];
  currentPortfolio?: Portfolio;
  optimizedPortfolios?: OptimizationResult[];
  interactive?: boolean;
  onPointClick?: (point: FrontierPoint) => void;
}

// Features:
// - ズーム・パン機能
// - ホバー詳細表示
// - 最適ポートフォリオハイライト
// - エクスポート機能
```

## 5. API設計

### 5.1 エンドポイント一覧

#### Assets API
```typescript
// GET /api/assets/search
// クエリパラメータ: q (検索文字列), type (資産タイプ), limit
// レスポンス: Asset[]

// GET /api/assets/[symbol]
// レスポンス: Asset

// GET /api/assets/[symbol]/history
// クエリパラメータ: start, end, interval
// レスポンス: HistoricalData[]

// GET /api/assets/batch
// ボディ: { symbols: string[] }
// レスポンス: Asset[]
```

#### Portfolio API
```typescript
// GET /api/portfolio/optimize
// ボディ: {
//   assets: string[],
//   startDate: string,
//   endDate: string,
//   optimizationType: OptimizationType,
//   constraints?: OptimizationConstraints
// }
// レスポンス: OptimizationResult

// POST /api/portfolio/analyze
// ボディ: {
//   portfolio: Portfolio,
//   startDate: string,
//   endDate: string
// }
// レスポンス: AnalysisResult

// POST /api/portfolio/backtest
// ボディ: {
//   portfolio: Portfolio,
//   startDate: string,
//   endDate: string,
//   rebalanceFrequency?: RebalanceFrequency
// }
// レスポンス: BacktestResult
```

### 5.2 エラーハンドリング

```typescript
// エラーコード定義
enum ErrorCode {
  // 4xx Client Errors
  INVALID_SYMBOL = 'INVALID_SYMBOL',
  INVALID_DATE_RANGE = 'INVALID_DATE_RANGE',
  TOO_MANY_ASSETS = 'TOO_MANY_ASSETS',
  INSUFFICIENT_DATA = 'INSUFFICIENT_DATA',
  
  // 5xx Server Errors
  EXTERNAL_API_ERROR = 'EXTERNAL_API_ERROR',
  CALCULATION_ERROR = 'CALCULATION_ERROR',
  RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED',
}

// エラーレスポンス例
{
  "success": false,
  "error": {
    "code": "INVALID_SYMBOL",
    "message": "The symbol 'XYZ' is not valid or not found.",
    "details": {
      "symbol": "XYZ",
      "suggestion": ["Did you mean 'XYZA'?"]
    }
  }
}
```

## 6. 状態管理設計

### 6.1 Zustand Store構造

```typescript
// Portfolio Store
interface PortfolioStore {
  // State
  portfolios: Portfolio[];
  currentPortfolio: Portfolio | null;
  isLoading: boolean;
  error: string | null;
  
  // Actions
  createPortfolio: (portfolio: Portfolio) => void;
  updatePortfolio: (id: string, updates: Partial<Portfolio>) => void;
  deletePortfolio: (id: string) => void;
  setCurrentPortfolio: (portfolio: Portfolio) => void;
  loadPortfolios: () => Promise<void>;
}

// Analysis Store
interface AnalysisStore {
  // State
  analysisResults: Map<string, AnalysisResult>;
  isAnalyzing: boolean;
  currentAnalysis: AnalysisResult | null;
  
  // Actions
  analyzePortfolio: (portfolio: Portfolio, params: AnalysisParams) => Promise<void>;
  clearAnalysis: () => void;
  exportAnalysis: (format: ExportFormat) => void;
}

// UI Store
interface UIStore {
  // State
  theme: 'light' | 'dark' | 'system';
  sidebarOpen: boolean;
  activeTab: string;
  notifications: Notification[];
  
  // Actions
  setTheme: (theme: Theme) => void;
  toggleSidebar: () => void;
  setActiveTab: (tab: string) => void;
  addNotification: (notification: Notification) => void;
  removeNotification: (id: string) => void;
}
```

## 7. パフォーマンス最適化

### 7.1 最適化戦略

#### コード分割
```typescript
// Dynamic imports for heavy components
const EfficiencyFrontier = dynamic(
  () => import('@/components/charts/EfficiencyFrontier'),
  { 
    loading: () => <ChartSkeleton />,
    ssr: false 
  }
);
```

#### データフェッチング
```typescript
// SWR with cache strategy
const { data, error } = useSWR(
  [`/api/assets/${symbol}/history`, startDate, endDate],
  fetcher,
  {
    revalidateOnFocus: false,
    revalidateOnReconnect: false,
    dedupingInterval: 60000, // 1分間キャッシュ
  }
);
```

#### メモ化
```typescript
// Heavy calculations memoization
const efficientFrontier = useMemo(
  () => calculateEfficientFrontier(returns, numPortfolios),
  [returns, numPortfolios]
);
```

### 7.2 バンドルサイズ最適化

```javascript
// next.config.js
module.exports = {
  experimental: {
    optimizeCss: true,
  },
  images: {
    domains: ['cdn.example.com'],
    formats: ['image/avif', 'image/webp'],
  },
  compress: true,
  productionBrowserSourceMaps: false,
};
```

## 8. セキュリティ設計

### 8.1 セキュリティ対策

#### Content Security Policy
```typescript
// middleware.ts
const csp = `
  default-src 'self';
  script-src 'self' 'unsafe-eval' 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  font-src 'self';
  connect-src 'self' https://query1.finance.yahoo.com;
`;
```

#### Rate Limiting
```typescript
// API rate limiting with upstash
import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, "10 s"),
});
```

#### Input Validation
```typescript
// Zod schemas for validation
const AssetSearchSchema = z.object({
  q: z.string().min(1).max(50),
  type: z.enum(['stock', 'etf', 'bond', 'commodity', 'crypto']).optional(),
  limit: z.number().min(1).max(100).default(20),
});
```

## 9. テスト戦略

### 9.1 テストカバレッジ目標

- Unit Tests: 90%
- Integration Tests: 70%
- E2E Tests: Critical paths

### 9.2 テスト例

```typescript
// Unit test example
describe('calculateSharpeRatio', () => {
  it('should calculate correct Sharpe ratio', () => {
    const returns = [0.01, 0.02, -0.01, 0.03];
    const riskFreeRate = 0.02;
    const result = calculateSharpeRatio(returns, riskFreeRate);
    expect(result).toBeCloseTo(0.58, 2);
  });
});

// Integration test example
describe('Portfolio API', () => {
  it('should optimize portfolio successfully', async () => {
    const response = await request(app)
      .post('/api/portfolio/optimize')
      .send({
        assets: ['SPY', 'GLD', 'BND'],
        startDate: '2023-01-01',
        endDate: '2024-01-01',
        optimizationType: 'max_sharpe'
      });
    
    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
    expect(response.body.data.weights).toHaveLength(3);
  });
});
```

## 10. デプロイメント設計

### 10.1 CI/CDパイプライン

```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - name: Install dependencies
        run: pnpm install
      - name: Run tests
        run: pnpm test
      - name: Build
        run: pnpm build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: vercel/action@v3
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

---
*最終更新日: 2024年12月*
*バージョン: 1.0.0*
