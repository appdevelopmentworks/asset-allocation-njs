# 実装ガイド - Asset Allocation Tool (Next.js版)

## 1. プロジェクトセットアップ

### 1.1 初期セットアップ
```bash
# プロジェクト作成
npx create-next-app@latest asset-allocation-nextjs \
  --typescript \
  --tailwind \
  --app \
  --src-dir \
  --import-alias "@/*"

cd asset-allocation-nextjs

# パッケージマネージャーをpnpmに変更
npm install -g pnpm
rm -rf node_modules package-lock.json
pnpm install
```

### 1.2 必要な依存関係のインストール
```bash
# Core Dependencies
pnpm add next@latest react@latest react-dom@latest

# UI Components & Styling
pnpm add @radix-ui/react-accordion @radix-ui/react-alert-dialog \
  @radix-ui/react-avatar @radix-ui/react-checkbox @radix-ui/react-dialog \
  @radix-ui/react-dropdown-menu @radix-ui/react-label @radix-ui/react-popover \
  @radix-ui/react-select @radix-ui/react-separator @radix-ui/react-slider \
  @radix-ui/react-switch @radix-ui/react-tabs @radix-ui/react-toast \
  @radix-ui/react-tooltip

pnpm add class-variance-authority clsx tailwind-merge lucide-react
pnpm add framer-motion

# Form & Validation
pnpm add react-hook-form zod @hookform/resolvers

# Data Fetching & State
pnpm add swr axios zustand immer

# Charts & Visualization
pnpm add recharts plotly.js react-plotly.js

# Date & Time
pnpm add date-fns

# Finance Data
pnpm add yahoo-finance2

# Utilities
pnpm add lodash numeral

# Development Dependencies
pnpm add -D @types/node @types/react @types/react-dom \
  @types/lodash @types/numeral \
  eslint eslint-config-next prettier \
  prettier-plugin-tailwindcss \
  @typescript-eslint/parser @typescript-eslint/eslint-plugin \
  husky lint-staged jest @testing-library/react \
  @testing-library/jest-dom @testing-library/user-event \
  playwright @playwright/test
```

### 1.3 shadcn/ui セットアップ
```bash
# shadcn/ui初期化
pnpm dlx shadcn-ui@latest init

# 必要なコンポーネントを追加
pnpm dlx shadcn-ui@latest add button
pnpm dlx shadcn-ui@latest add card
pnpm dlx shadcn-ui@latest add dialog
pnpm dlx shadcn-ui@latest add dropdown-menu
pnpm dlx shadcn-ui@latest add form
pnpm dlx shadcn-ui@latest add input
pnpm dlx shadcn-ui@latest add label
pnpm dlx shadcn-ui@latest add select
pnpm dlx shadcn-ui@latest add separator
pnpm dlx shadcn-ui@latest add skeleton
pnpm dlx shadcn-ui@latest add tabs
pnpm dlx shadcn-ui@latest add toast
pnpm dlx shadcn-ui@latest add tooltip
```

## 2. プロジェクト構造の作成

### 2.1 ディレクトリ作成スクリプト
```bash
#!/bin/bash
# create-structure.sh

# Create main directories
mkdir -p src/app/{api,\(dashboard\),\(auth\)}
mkdir -p src/app/api/{assets,portfolio,optimize,market}
mkdir -p src/app/\(dashboard\)/{portfolio,analysis,settings}
mkdir -p src/components/{ui,charts,forms,layouts,features}
mkdir -p src/components/features/{portfolio,analysis,optimization}
mkdir -p src/lib/{api,calculations,constants,hooks,stores,types,utils,validations}
mkdir -p src/styles
mkdir -p src/tests/{unit,integration,e2e}
mkdir -p public/{images,fonts}

# Create placeholder files
touch src/app/layout.tsx
touch src/app/page.tsx
touch src/app/globals.css
touch src/lib/utils.ts
touch src/lib/constants/index.ts
touch src/lib/types/index.ts
```

## 3. 基本設定ファイル

### 3.1 TypeScript設定 (tsconfig.json)
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"],
      "@/components/*": ["./src/components/*"],
      "@/lib/*": ["./src/lib/*"],
      "@/hooks/*": ["./src/lib/hooks/*"],
      "@/types/*": ["./src/lib/types/*"],
      "@/utils/*": ["./src/lib/utils/*"],
      "@/stores/*": ["./src/lib/stores/*"],
      "@/api/*": ["./src/lib/api/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

### 3.2 Tailwind設定 (tailwind.config.ts)
```typescript
import type { Config } from 'tailwindcss'

const config: Config = {
  darkMode: ['class'],
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    container: {
      center: true,
      padding: '2rem',
      screens: {
        '2xl': '1400px',
      },
    },
    extend: {
      colors: {
        border: 'hsl(var(--border))',
        input: 'hsl(var(--input))',
        ring: 'hsl(var(--ring))',
        background: 'hsl(var(--background))',
        foreground: 'hsl(var(--foreground))',
        primary: {
          DEFAULT: 'hsl(var(--primary))',
          foreground: 'hsl(var(--primary-foreground))',
        },
        secondary: {
          DEFAULT: 'hsl(var(--secondary))',
          foreground: 'hsl(var(--secondary-foreground))',
        },
        destructive: {
          DEFAULT: 'hsl(var(--destructive))',
          foreground: 'hsl(var(--destructive-foreground))',
        },
        muted: {
          DEFAULT: 'hsl(var(--muted))',
          foreground: 'hsl(var(--muted-foreground))',
        },
        accent: {
          DEFAULT: 'hsl(var(--accent))',
          foreground: 'hsl(var(--accent-foreground))',
        },
        popover: {
          DEFAULT: 'hsl(var(--popover))',
          foreground: 'hsl(var(--popover-foreground))',
        },
        card: {
          DEFAULT: 'hsl(var(--card))',
          foreground: 'hsl(var(--card-foreground))',
        },
        chart: {
          '1': 'hsl(var(--chart-1))',
          '2': 'hsl(var(--chart-2))',
          '3': 'hsl(var(--chart-3))',
          '4': 'hsl(var(--chart-4))',
          '5': 'hsl(var(--chart-5))',
        },
      },
      borderRadius: {
        lg: 'var(--radius)',
        md: 'calc(var(--radius) - 2px)',
        sm: 'calc(var(--radius) - 4px)',
      },
      keyframes: {
        'accordion-down': {
          from: { height: '0' },
          to: { height: 'var(--radix-accordion-content-height)' },
        },
        'accordion-up': {
          from: { height: 'var(--radix-accordion-content-height)' },
          to: { height: '0' },
        },
      },
      animation: {
        'accordion-down': 'accordion-down 0.2s ease-out',
        'accordion-up': 'accordion-up 0.2s ease-out',
      },
    },
  },
  plugins: [require('tailwindcss-animate')],
}

export default config
```

### 3.3 Next.js設定 (next.config.js)
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    serverActions: true,
  },
  images: {
    domains: ['logo.clearbit.com', 'cdn.jsdelivr.net'],
    formats: ['image/avif', 'image/webp'],
  },
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block',
          },
        ],
      },
    ]
  },
}

module.exports = nextConfig
```

## 4. コア実装

### 4.1 型定義 (src/lib/types/index.ts)
```typescript
// Asset Types
export interface Asset {
  id: string
  symbol: string
  name: string
  type: AssetType
  exchange?: string
  currency?: string
  logo?: string
}

export enum AssetType {
  STOCK = 'stock',
  ETF = 'etf',
  BOND = 'bond',
  COMMODITY = 'commodity',
  CRYPTO = 'crypto',
  REIT = 'reit',
}

// Portfolio Types
export interface Portfolio {
  id: string
  name: string
  assets: PortfolioAsset[]
  createdAt: Date
  updatedAt: Date
  settings?: PortfolioSettings
}

export interface PortfolioAsset {
  asset: Asset
  weight: number
  quantity?: number
  value?: number
}

export interface PortfolioSettings {
  rebalanceFrequency?: RebalanceFrequency
  riskTolerance?: RiskTolerance
  targetReturn?: number
}

export enum RebalanceFrequency {
  MONTHLY = 'monthly',
  QUARTERLY = 'quarterly',
  ANNUALLY = 'annually',
}

export enum RiskTolerance {
  LOW = 'low',
  MODERATE = 'moderate',
  HIGH = 'high',
}

// Analysis Types
export interface AnalysisResult {
  portfolioId: string
  metrics: PortfolioMetrics
  efficientFrontier?: FrontierPoint[]
  correlationMatrix?: number[][]
  historicalReturns?: TimeSeries[]
}

export interface PortfolioMetrics {
  totalReturn: number
  annualizedReturn: number
  volatility: number
  sharpeRatio: number
  sortinoRatio?: number
  maxDrawdown: number
  var95?: number
  cvar95?: number
  beta?: number
  alpha?: number
}

export interface FrontierPoint {
  risk: number
  return: number
  weights?: number[]
}

export interface TimeSeries {
  date: Date
  value: number
}

// API Types
export interface ApiResponse<T> {
  success: boolean
  data?: T
  error?: ApiError
  metadata?: ResponseMetadata
}

export interface ApiError {
  code: string
  message: string
  details?: any
}

export interface ResponseMetadata {
  timestamp: string
  version: string
  cached: boolean
  ttl?: number
}
```

### 4.2 API Client (src/lib/api/client.ts)
```typescript
import axios, { AxiosInstance, AxiosRequestConfig } from 'axios'
import { ApiResponse, ApiError } from '@/types'

class ApiClient {
  private client: AxiosInstance

  constructor(baseURL?: string) {
    this.client = axios.create({
      baseURL: baseURL || process.env.NEXT_PUBLIC_API_URL || '/api',
      timeout: 30000,
      headers: {
        'Content-Type': 'application/json',
      },
    })

    // Request interceptor
    this.client.interceptors.request.use(
      (config) => {
        // Add auth token if available
        const token = this.getAuthToken()
        if (token) {
          config.headers.Authorization = `Bearer ${token}`
        }
        return config
      },
      (error) => Promise.reject(error)
    )

    // Response interceptor
    this.client.interceptors.response.use(
      (response) => response,
      async (error) => {
        if (error.response?.status === 401) {
          // Handle token refresh
          await this.refreshToken()
        }
        return Promise.reject(this.normalizeError(error))
      }
    )
  }

  private getAuthToken(): string | null {
    // Implement token retrieval
    return localStorage.getItem('auth_token')
  }

  private async refreshToken(): Promise<void> {
    // Implement token refresh logic
  }

  private normalizeError(error: any): ApiError {
    if (error.response?.data?.error) {
      return error.response.data.error
    }
    return {
      code: 'UNKNOWN_ERROR',
      message: error.message || 'An unknown error occurred',
      details: error,
    }
  }

  async get<T>(url: string, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {
    const response = await this.client.get<ApiResponse<T>>(url, config)
    return response.data
  }

  async post<T>(url: string, data?: any, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {
    const response = await this.client.post<ApiResponse<T>>(url, data, config)
    return response.data
  }

  async put<T>(url: string, data?: any, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {
    const response = await this.client.put<ApiResponse<T>>(url, data, config)
    return response.data
  }

  async delete<T>(url: string, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {
    const response = await this.client.delete<ApiResponse<T>>(url, config)
    return response.data
  }
}

export const apiClient = new ApiClient()
```

### 4.3 Store実装 (src/lib/stores/portfolio.ts)
```typescript
import { create } from 'zustand'
import { devtools, persist } from 'zustand/middleware'
import { immer } from 'zustand/middleware/immer'
import { Portfolio, PortfolioAsset } from '@/types'

interface PortfolioState {
  portfolios: Portfolio[]
  currentPortfolio: Portfolio | null
  isLoading: boolean
  error: string | null
}

interface PortfolioActions {
  createPortfolio: (portfolio: Omit<Portfolio, 'id' | 'createdAt' | 'updatedAt'>) => void
  updatePortfolio: (id: string, updates: Partial<Portfolio>) => void
  deletePortfolio: (id: string) => void
  setCurrentPortfolio: (portfolio: Portfolio | null) => void
  addAsset: (portfolioId: string, asset: PortfolioAsset) => void
  removeAsset: (portfolioId: string, assetId: string) => void
  updateAssetWeight: (portfolioId: string, assetId: string, weight: number) => void
  rebalancePortfolio: (portfolioId: string) => void
  setLoading: (isLoading: boolean) => void
  setError: (error: string | null) => void
  reset: () => void
}

type PortfolioStore = PortfolioState & PortfolioActions

const initialState: PortfolioState = {
  portfolios: [],
  currentPortfolio: null,
  isLoading: false,
  error: null,
}

export const usePortfolioStore = create<PortfolioStore>()(
  devtools(
    persist(
      immer((set, get) => ({
        ...initialState,

        createPortfolio: (portfolio) =>
          set((state) => {
            const newPortfolio: Portfolio = {
              ...portfolio,
              id: crypto.randomUUID(),
              createdAt: new Date(),
              updatedAt: new Date(),
            }
            state.portfolios.push(newPortfolio)
            state.currentPortfolio = newPortfolio
          }),

        updatePortfolio: (id, updates) =>
          set((state) => {
            const index = state.portfolios.findIndex((p) => p.id === id)
            if (index !== -1) {
              state.portfolios[index] = {
                ...state.portfolios[index],
                ...updates,
                updatedAt: new Date(),
              }
              if (state.currentPortfolio?.id === id) {
                state.currentPortfolio = state.portfolios[index]
              }
            }
          }),

        deletePortfolio: (id) =>
          set((state) => {
            state.portfolios = state.portfolios.filter((p) => p.id !== id)
            if (state.currentPortfolio?.id === id) {
              state.currentPortfolio = null
            }
          }),

        setCurrentPortfolio: (portfolio) =>
          set((state) => {
            state.currentPortfolio = portfolio
          }),

        addAsset: (portfolioId, asset) =>
          set((state) => {
            const portfolio = state.portfolios.find((p) => p.id === portfolioId)
            if (portfolio) {
              portfolio.assets.push(asset)
              portfolio.updatedAt = new Date()
            }
          }),

        removeAsset: (portfolioId, assetId) =>
          set((state) => {
            const portfolio = state.portfolios.find((p) => p.id === portfolioId)
            if (portfolio) {
              portfolio.assets = portfolio.assets.filter((a) => a.asset.id !== assetId)
              portfolio.updatedAt = new Date()
            }
          }),

        updateAssetWeight: (portfolioId, assetId, weight) =>
          set((state) => {
            const portfolio = state.portfolios.find((p) => p.id === portfolioId)
            if (portfolio) {
              const asset = portfolio.assets.find((a) => a.asset.id === assetId)
              if (asset) {
                asset.weight = weight
                portfolio.updatedAt = new Date()
              }
            }
          }),

        rebalancePortfolio: (portfolioId) =>
          set((state) => {
            const portfolio = state.portfolios.find((p) => p.id === portfolioId)
            if (portfolio) {
              const equalWeight = 1 / portfolio.assets.length
              portfolio.assets.forEach((asset) => {
                asset.weight = equalWeight
              })
              portfolio.updatedAt = new Date()
            }
          }),

        setLoading: (isLoading) =>
          set((state) => {
            state.isLoading = isLoading
          }),

        setError: (error) =>
          set((state) => {
            state.error = error
          }),

        reset: () => set(initialState),
      })),
      {
        name: 'portfolio-storage',
      }
    )
  )
)
```

### 4.4 カスタムフック (src/lib/hooks/useAssets.ts)
```typescript
import useSWR from 'swr'
import { apiClient } from '@/api/client'
import { Asset } from '@/types'

export function useAssetSearch(query: string) {
  const { data, error, isLoading } = useSWR(
    query ? `/assets/search?q=${encodeURIComponent(query)}` : null,
    (url) => apiClient.get<Asset[]>(url),
    {
      revalidateOnFocus: false,
      dedupingInterval: 2000,
    }
  )

  return {
    assets: data?.data || [],
    isLoading,
    isError: !!error,
    error,
  }
}

export function useAsset(symbol: string) {
  const { data, error, isLoading, mutate } = useSWR(
    symbol ? `/assets/${symbol}` : null,
    (url) => apiClient.get<Asset>(url),
    {
      revalidateOnFocus: false,
    }
  )

  return {
    asset: data?.data,
    isLoading,
    isError: !!error,
    error,
    mutate,
  }
}

export function useAssetHistory(symbol: string, startDate: string, endDate: string) {
  const { data, error, isLoading } = useSWR(
    symbol ? `/assets/${symbol}/history?start=${startDate}&end=${endDate}` : null,
    (url) => apiClient.get(url),
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: false,
      dedupingInterval: 60000, // Cache for 1 minute
    }
  )

  return {
    history: data?.data,
    isLoading,
    isError: !!error,
    error,
  }
}
```

## 5. コンポーネント実装例

### 5.1 AssetSelector Component
```typescript
// src/components/forms/AssetSelector.tsx
'use client'

import { useState, useCallback, useEffect } from 'react'
import { Check, ChevronsUpDown, X } from 'lucide-react'
import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
} from '@/components/ui/command'
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover'
import { Badge } from '@/components/ui/badge'
import { useAssetSearch } from '@/hooks/useAssets'
import { Asset } from '@/types'
import { debounce } from 'lodash'

interface AssetSelectorProps {
  selectedAssets: Asset[]
  onAssetsChange: (assets: Asset[]) => void
  maxAssets?: number
  placeholder?: string
  className?: string
}

export function AssetSelector({
  selectedAssets,
  onAssetsChange,
  maxAssets = 10,
  placeholder = 'Search assets...',
  className,
}: AssetSelectorProps) {
  const [open, setOpen] = useState(false)
  const [searchQuery, setSearchQuery] = useState('')
  const { assets, isLoading } = useAssetSearch(searchQuery)

  const debouncedSearch = useCallback(
    debounce((query: string) => {
      setSearchQuery(query)
    }, 300),
    []
  )

  const handleSelect = (asset: Asset) => {
    const isSelected = selectedAssets.some((a) => a.id === asset.id)
    
    if (isSelected) {
      onAssetsChange(selectedAssets.filter((a) => a.id !== asset.id))
    } else if (selectedAssets.length < maxAssets) {
      onAssetsChange([...selectedAssets, asset])
    }
  }

  const handleRemove = (assetId: string) => {
    onAssetsChange(selectedAssets.filter((a) => a.id !== assetId))
  }

  return (
    <div className={cn('space-y-2', className)}>
      <Popover open={open} onOpenChange={setOpen}>
        <PopoverTrigger asChild>
          <Button
            variant="outline"
            role="combobox"
            aria-expanded={open}
            className="w-full justify-between"
          >
            <span className="truncate">
              {selectedAssets.length > 0
                ? `${selectedAssets.length} assets selected`
                : placeholder}
            </span>
            <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
          </Button>
        </PopoverTrigger>
        <PopoverContent className="w-full p-0">
          <Command>
            <CommandInput
              placeholder={placeholder}
              onValueChange={debouncedSearch}
            />
            <CommandEmpty>
              {isLoading ? 'Searching...' : 'No assets found.'}
            </CommandEmpty>
            <CommandGroup>
              {assets.map((asset) => {
                const isSelected = selectedAssets.some((a) => a.id === asset.id)
                return (
                  <CommandItem
                    key={asset.id}
                    value={asset.symbol}
                    onSelect={() => handleSelect(asset)}
                    disabled={!isSelected && selectedAssets.length >= maxAssets}
                  >
                    <Check
                      className={cn(
                        'mr-2 h-4 w-4',
                        isSelected ? 'opacity-100' : 'opacity-0'
                      )}
                    />
                    <div className="flex-1">
                      <div className="font-medium">{asset.symbol}</div>
                      <div className="text-sm text-muted-foreground">
                        {asset.name}
                      </div>
                    </div>
                    <Badge variant="secondary" className="ml-2">
                      {asset.type}
                    </Badge>
                  </CommandItem>
                )
              })}
            </CommandGroup>
          </Command>
        </PopoverContent>
      </Popover>

      {selectedAssets.length > 0 && (
        <div className="flex flex-wrap gap-2">
          {selectedAssets.map((asset) => (
            <Badge key={asset.id} variant="secondary">
              {asset.symbol}
              <Button
                variant="ghost"
                size="sm"
                className="ml-1 h-auto p-0"
                onClick={() => handleRemove(asset.id)}
              >
                <X className="h-3 w-3" />
              </Button>
            </Badge>
          ))}
        </div>
      )}
    </div>
  )
}
```

### 5.2 EfficiencyFrontier Chart Component
```typescript
// src/components/charts/EfficiencyFrontier.tsx
'use client'

import { useMemo } from 'react'
import dynamic from 'next/dynamic'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Skeleton } from '@/components/ui/skeleton'
import { FrontierPoint, OptimizationResult } from '@/types'

const Plot = dynamic(() => import('react-plotly.js'), {
  ssr: false,
  loading: () => <Skeleton className="h-[400px] w-full" />,
})

interface EfficiencyFrontierProps {
  data: FrontierPoint[]
  currentPortfolio?: FrontierPoint
  optimizedPortfolios?: OptimizationResult[]
  height?: number
}

export function EfficiencyFrontier({
  data,
  currentPortfolio,
  optimizedPortfolios,
  height = 400,
}: EfficiencyFrontierProps) {
  const plotData = useMemo(() => {
    const traces: any[] = []

    // Efficient Frontier
    if (data.length > 0) {
      traces.push({
        x: data.map((d) => d.risk * 100),
        y: data.map((d) => d.return * 100),
        type: 'scatter',
        mode: 'markers',
        name: 'Random Portfolios',
        marker: {
          color: data.map((d) => d.return / d.risk),
          colorscale: 'Viridis',
          showscale: true,
          size: 5,
          colorbar: {
            title: 'Sharpe Ratio',
          },
        },
        hovertemplate:
          '<b>Risk:</b> %{x:.2f}%<br>' +
          '<b>Return:</b> %{y:.2f}%<br>' +
          '<extra></extra>',
      })
    }

    // Current Portfolio
    if (currentPortfolio) {
      traces.push({
        x: [currentPortfolio.risk * 100],
        y: [currentPortfolio.return * 100],
        type: 'scatter',
        mode: 'markers',
        name: 'Current Portfolio',
        marker: {
          color: '#3b82f6',
          size: 15,
          symbol: 'star',
        },
        hovertemplate:
          '<b>Current Portfolio</b><br>' +
          'Risk: %{x:.2f}%<br>' +
          'Return: %{y:.2f}%<br>' +
          '<extra></extra>',
      })
    }

    // Optimized Portfolios
    if (optimizedPortfolios && optimizedPortfolios.length > 0) {
      optimizedPortfolios.forEach((portfolio) => {
        traces.push({
          x: [portfolio.risk * 100],
          y: [portfolio.expectedReturn * 100],
          type: 'scatter',
          mode: 'markers',
          name: portfolio.type,
          marker: {
            size: 12,
            symbol: 'diamond',
          },
        })
      })
    }

    return traces
  }, [data, currentPortfolio, optimizedPortfolios])

  const layout = {
    title: 'Efficient Frontier',
    xaxis: {
      title: 'Risk (Standard Deviation %)',
      showgrid: true,
      zeroline: false,
    },
    yaxis: {
      title: 'Expected Return (%)',
      showgrid: true,
      zeroline: false,
    },
    hovermode: 'closest',
    showlegend: true,
    height,
    margin: { t: 40, r: 40, b: 60, l: 60 },
    paper_bgcolor: 'transparent',
    plot_bgcolor: 'transparent',
  }

  const config = {
    displayModeBar: true,
    displaylogo: false,
    modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d'],
    responsive: true,
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Risk-Return Analysis</CardTitle>
      </CardHeader>
      <CardContent>
        <Plot data={plotData} layout={layout} config={config} />
      </CardContent>
    </Card>
  )
}
```

## 6. API Routes実装

### 6.1 Assets API Route
```typescript
// src/app/api/assets/[symbol]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import yahooFinance from 'yahoo-finance2'
import { z } from 'zod'

const paramsSchema = z.object({
  symbol: z.string().min(1).max(10),
})

export async function GET(
  request: NextRequest,
  { params }: { params: { symbol: string } }
) {
  try {
    const { symbol } = paramsSchema.parse(params)

    const quote = await yahooFinance.quote(symbol)
    
    return NextResponse.json({
      success: true,
      data: {
        id: quote.symbol,
        symbol: quote.symbol,
        name: quote.longName || quote.shortName,
        type: quote.quoteType?.toLowerCase(),
        exchange: quote.exchange,
        currency: quote.currency,
        currentPrice: quote.regularMarketPrice,
        dayChange: quote.regularMarketChange,
        dayChangePercent: quote.regularMarketChangePercent,
        volume: quote.regularMarketVolume,
        marketCap: quote.marketCap,
        pe: quote.trailingPE,
        eps: quote.epsTrailingTwelveMonths,
        dividend: quote.dividendRate,
        dividendYield: quote.dividendYield,
        beta: quote.beta,
      },
      metadata: {
        timestamp: new Date().toISOString(),
        version: 'v1',
        cached: false,
      },
    })
  } catch (error) {
    console.error('Error fetching asset:', error)
    
    return NextResponse.json(
      {
        success: false,
        error: {
          code: 'ASSET_NOT_FOUND',
          message: `Asset ${params.symbol} not found`,
        },
      },
      { status: 404 }
    )
  }
}
```

---
*最終更新日: 2024年12月*
*バージョン: 1.0.0*
