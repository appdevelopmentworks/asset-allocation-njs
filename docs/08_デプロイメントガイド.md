# デプロイメントガイド - Asset Allocation Tool

## 1. デプロイメントアーキテクチャ

### 1.1 インフラ構成図
```
┌─────────────────────────────────────────────────────────┐
│                      Cloudflare                         │
│                    (DNS, CDN, DDoS)                     │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                        Vercel                           │
│              (Next.js App Hosting, Edge Functions)      │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Production: app.assetallocation.com            │   │
│  │  Staging: staging.assetallocation.com           │   │
│  │  Preview: pr-*.assetallocation.vercel.app       │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
        ┌──────────────────┐  ┌──────────────────┐
        │    Supabase      │  │    Upstash       │
        │   (PostgreSQL)   │  │    (Redis)       │
        └──────────────────┘  └──────────────────┘
                    │
                    ▼
        ┌──────────────────┐
        │  External APIs   │
        │  - Yahoo Finance │
        │  - Alpha Vantage │
        └──────────────────┘
```

### 1.2 環境構成
| 環境 | URL | ブランチ | 用途 |
|-----|-----|---------|-----|
| Production | app.assetallocation.com | main | 本番環境 |
| Staging | staging.assetallocation.com | staging | ステージング環境 |
| Preview | pr-*.vercel.app | feature/* | PR毎のプレビュー |
| Development | localhost:3000 | develop | ローカル開発 |

## 2. Vercel デプロイメント

### 2.1 初期セットアップ

#### Vercel CLIインストール
```bash
# Install Vercel CLI
npm i -g vercel

# Login to Vercel
vercel login

# Link project
vercel link
```

#### プロジェクト設定
```bash
# Initialize Vercel project
vercel

# Follow prompts:
# - Set up and deploy? Yes
# - Which scope? Your account
# - Link to existing project? No
# - Project name? asset-allocation-nextjs
# - Directory? ./
# - Override settings? No
```

### 2.2 環境変数設定

#### Production環境変数
```bash
# Database
DATABASE_URL="postgresql://user:pass@db.supabase.co:5432/postgres"
DIRECT_URL="postgresql://user:pass@db.supabase.co:5432/postgres"

# Supabase
NEXT_PUBLIC_SUPABASE_URL="https://project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJ..."
SUPABASE_SERVICE_ROLE_KEY="eyJ..."

# Redis (Upstash)
UPSTASH_REDIS_REST_URL="https://project.upstash.io"
UPSTASH_REDIS_REST_TOKEN="token"

# API Keys
YAHOO_FINANCE_API_KEY="key"
ALPHA_VANTAGE_API_KEY="key"

# Auth (将来実装)
NEXTAUTH_URL="https://app.assetallocation.com"
NEXTAUTH_SECRET="secret"

# Monitoring
SENTRY_DSN="https://public@sentry.io/project"
VERCEL_ANALYTICS_ID="id"

# Feature Flags
NEXT_PUBLIC_ENABLE_BETA_FEATURES="false"
```

#### Vercel環境変数設定
```bash
# Set environment variables via CLI
vercel env add DATABASE_URL production
vercel env add NEXT_PUBLIC_SUPABASE_URL production

# Or via vercel.json
```

### 2.3 vercel.json設定

```json
{
  "framework": "nextjs",
  "buildCommand": "pnpm build",
  "devCommand": "pnpm dev",
  "installCommand": "pnpm install",
  "regions": ["iad1"],
  "functions": {
    "app/api/portfolio/optimize/route.ts": {
      "maxDuration": 30,
      "memory": 1024
    },
    "app/api/assets/*/route.ts": {
      "maxDuration": 10,
      "memory": 512
    }
  },
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        },
        {
          "key": "Referrer-Policy",
          "value": "strict-origin-when-cross-origin"
        },
        {
          "key": "Permissions-Policy",
          "value": "camera=(), microphone=(), geolocation=()"
        }
      ]
    },
    {
      "source": "/api/:path*",
      "headers": [
        {
          "key": "Access-Control-Allow-Origin",
          "value": "https://app.assetallocation.com"
        },
        {
          "key": "Access-Control-Allow-Methods",
          "value": "GET, POST, PUT, DELETE, OPTIONS"
        },
        {
          "key": "Access-Control-Allow-Headers",
          "value": "Content-Type, Authorization"
        }
      ]
    }
  ],
  "redirects": [
    {
      "source": "/",
      "destination": "/dashboard",
      "permanent": false
    }
  ],
  "rewrites": [
    {
      "source": "/api/v1/:path*",
      "destination": "/api/:path*"
    }
  ],
  "crons": [
    {
      "path": "/api/cron/update-prices",
      "schedule": "0 2 * * *"
    },
    {
      "path": "/api/cron/cleanup",
      "schedule": "0 3 * * 0"
    }
  ]
}
```

### 2.4 デプロイコマンド

```bash
# Production deployment
vercel --prod

# Staging deployment
vercel --prod --env staging

# Preview deployment (automatic on PR)
git push origin feature/new-feature

# Rollback
vercel rollback

# Promote preview to production
vercel promote [deployment-url]
```

## 3. Database Setup (Supabase)

### 3.1 Supabase プロジェクト作成

```bash
# Install Supabase CLI
npm install -g supabase

# Login
supabase login

# Initialize project
supabase init

# Link to remote project
supabase link --project-ref [project-ref]
```

### 3.2 マイグレーション

```bash
# Create migration
supabase migration new create_initial_schema

# Apply migrations locally
supabase db reset

# Push to production
supabase db push

# Generate TypeScript types
supabase gen types typescript --local > lib/database.types.ts
```

### 3.3 Edge Functions

```typescript
// supabase/functions/calculate-portfolio/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const { portfolioId } = await req.json()
  
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  )
  
  // Portfolio calculation logic
  
  return new Response(
    JSON.stringify({ success: true, data: result }),
    { headers: { 'Content-Type': 'application/json' } }
  )
})
```

Deploy Edge Function:
```bash
supabase functions deploy calculate-portfolio
```

## 4. Redis Setup (Upstash)

### 4.1 Upstash Configuration

```typescript
// lib/redis.ts
import { Redis } from '@upstash/redis'

export const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL!,
  token: process.env.UPSTASH_REDIS_REST_TOKEN!,
})

// Rate limiting setup
import { Ratelimit } from '@upstash/ratelimit'

export const ratelimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(10, '10 s'),
  analytics: true,
})
```

### 4.2 Cache Warming Script

```typescript
// scripts/warm-cache.ts
import { redis } from '@/lib/redis'
import { fetchPopularAssets, fetchMarketData } from '@/lib/api'

async function warmCache() {
  console.log('Warming cache...')
  
  // Cache popular assets
  const assets = await fetchPopularAssets()
  await redis.setex('popular_assets', 3600, JSON.stringify(assets))
  
  // Cache market data
  const marketData = await fetchMarketData()
  await redis.setex('market_data', 300, JSON.stringify(marketData))
  
  console.log('Cache warming complete')
}

warmCache()
```

## 5. CI/CD Pipeline

### 5.1 GitHub Actions Workflow

```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [main, staging]
  pull_request:
    types: [opened, synchronize, reopened]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm type-check
      - run: pnpm test
      - run: pnpm build

  deploy-preview:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v3
      
      - run: pnpm install
      - run: pnpm install -g vercel
      
      - name: Deploy to Vercel Preview
        run: |
          vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}

  deploy-staging:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/staging'
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v3
      
      - run: pnpm install
      - run: pnpm install -g vercel
      
      - name: Deploy to Staging
        run: |
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_SCOPE: staging

  deploy-production:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v3
      
      - run: pnpm install
      - run: pnpm install -g vercel
      
      - name: Deploy to Production
        run: |
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Run E2E Tests
        run: pnpm test:e2e:production
      
      - name: Purge CDN Cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
```

### 5.2 Pre-deployment Checklist

```yaml
# .github/PULL_REQUEST_TEMPLATE.md
## Pre-deployment Checklist

- [ ] Code review completed
- [ ] All tests passing
- [ ] No console errors
- [ ] Performance metrics acceptable
- [ ] Security scan passed
- [ ] Database migrations ready
- [ ] Environment variables updated
- [ ] Documentation updated
- [ ] Rollback plan prepared

## Deployment Notes
<!-- Any special deployment instructions -->
```

## 6. Monitoring & Observability

### 6.1 Vercel Analytics Setup

```typescript
// app/layout.tsx
import { Analytics } from '@vercel/analytics/react'
import { SpeedInsights } from '@vercel/speed-insights/next'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>
        {children}
        <Analytics />
        <SpeedInsights />
      </body>
    </html>
  )
}
```

### 6.2 Sentry Error Tracking

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  debug: false,
  replaysOnErrorSampleRate: 1.0,
  replaysSessionSampleRate: 0.1,
  integrations: [
    new Sentry.Replay({
      maskAllText: true,
      blockAllMedia: true,
    }),
  ],
})
```

### 6.3 Custom Monitoring

```typescript
// lib/monitoring.ts
export async function trackEvent(
  event: string,
  properties?: Record<string, any>
) {
  // Send to analytics service
  if (typeof window !== 'undefined' && window.gtag) {
    window.gtag('event', event, properties)
  }
  
  // Log to application insights
  await fetch('/api/telemetry', {
    method: 'POST',
    body: JSON.stringify({ event, properties }),
  })
}

export function trackPageView(url: string) {
  trackEvent('page_view', { page_path: url })
}

export function trackApiCall(
  endpoint: string,
  duration: number,
  status: number
) {
  trackEvent('api_call', {
    endpoint,
    duration,
    status,
    success: status >= 200 && status < 300,
  })
}
```

## 7. Performance Optimization

### 7.1 Build Optimization

```javascript
// next.config.js
module.exports = {
  images: {
    domains: ['cdn.example.com'],
    formats: ['image/avif', 'image/webp'],
  },
  experimental: {
    optimizeCss: true,
    optimizePackageImports: ['lodash', 'date-fns'],
  },
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production',
  },
  swcMinify: true,
  compress: true,
  poweredByHeader: false,
  generateEtags: true,
}
```

### 7.2 Bundle Analysis

```bash
# Analyze bundle size
pnpm analyze

# package.json scripts
{
  "scripts": {
    "analyze": "ANALYZE=true next build",
    "analyze:server": "BUNDLE_ANALYZE=server next build",
    "analyze:browser": "BUNDLE_ANALYZE=browser next build"
  }
}
```

## 8. Rollback Strategy

### 8.1 Automatic Rollback

```yaml
# .github/workflows/rollback.yml
name: Automatic Rollback

on:
  workflow_dispatch:
  repository_dispatch:
    types: [rollback]

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Rollback Vercel Deployment
        run: |
          vercel rollback --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Rollback Database Migration
        run: |
          supabase db reset --version ${{ github.event.client_payload.version }}
      
      - name: Clear Cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
      
      - name: Notify Team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production rollback completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

### 8.2 Manual Rollback Steps

```bash
# 1. List recent deployments
vercel list

# 2. Find the last stable deployment
vercel inspect [deployment-url]

# 3. Promote stable deployment
vercel promote [deployment-url]

# 4. Verify rollback
curl -I https://app.assetallocation.com

# 5. Rollback database if needed
supabase db reset --version [previous-version]

# 6. Clear CDN cache
curl -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/purge_cache"
```

## 9. Security Hardening

### 9.1 Security Headers

```typescript
// middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const response = NextResponse.next()
  
  // Security headers
  response.headers.set('X-DNS-Prefetch-Control', 'on')
  response.headers.set('Strict-Transport-Security', 'max-age=63072000; includeSubDomains; preload')
  response.headers.set('X-Content-Type-Options', 'nosniff')
  response.headers.set('X-Frame-Options', 'DENY')
  response.headers.set('X-XSS-Protection', '1; mode=block')
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
  
  // CSP
  response.headers.set(
    'Content-Security-Policy',
    "default-src 'self'; " +
    "script-src 'self' 'unsafe-inline' 'unsafe-eval' *.vercel-insights.com; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' data: https:; " +
    "font-src 'self' data:; " +
    "connect-src 'self' *.supabase.co *.upstash.io; " +
    "frame-ancestors 'none';"
  )
  
  return response
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
}
```

### 9.2 Rate Limiting

```typescript
// app/api/middleware.ts
import { ratelimit } from '@/lib/redis'

export async function rateLimitMiddleware(req: Request) {
  const ip = req.headers.get('x-forwarded-for') ?? 'unknown'
  const { success, limit, reset, remaining } = await ratelimit.limit(ip)
  
  if (!success) {
    return new Response('Too Many Requests', {
      status: 429,
      headers: {
        'X-RateLimit-Limit': limit.toString(),
        'X-RateLimit-Remaining': remaining.toString(),
        'X-RateLimit-Reset': new Date(reset).toISOString(),
      },
    })
  }
  
  return null
}
```

## 10. Post-Deployment Tasks

### 10.1 Health Check

```bash
#!/bin/bash
# scripts/health-check.sh

URL="https://app.assetallocation.com"

echo "Running health checks..."

# Check homepage
curl -f -s -o /dev/null -w "%{http_code}" $URL/
echo "Homepage: $?"

# Check API
curl -f -s -o /dev/null -w "%{http_code}" $URL/api/health
echo "API Health: $?"

# Check assets loading
curl -f -s -o /dev/null -w "%{http_code}" $URL/_next/static/
echo "Static Assets: $?"

# Performance check
curl -w "@curl-format.txt" -o /dev/null -s $URL/

echo "Health check complete"
```

### 10.2 Deployment Notification

```typescript
// scripts/notify-deployment.ts
async function notifyDeployment() {
  const deployment = {
    environment: process.env.VERCEL_ENV,
    url: process.env.VERCEL_URL,
    commit: process.env.VERCEL_GIT_COMMIT_SHA,
    branch: process.env.VERCEL_GIT_COMMIT_REF,
    timestamp: new Date().toISOString(),
  }
  
  // Slack notification
  await fetch(process.env.SLACK_WEBHOOK_URL!, {
    method: 'POST',
    body: JSON.stringify({
      text: `Deployment completed: ${deployment.environment}`,
      blocks: [
        {
          type: 'section',
          text: {
            type: 'mrkdwn',
            text: `*Environment:* ${deployment.environment}\n*URL:* ${deployment.url}\n*Branch:* ${deployment.branch}`,
          },
        },
      ],
    }),
  })
}
```

---
*最終更新日: 2024年12月*
*バージョン: 1.0.0*
